---
output:html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


## Оптическое распознавание символов

**Особенности материала**:

  1. Взаимная конвертация файлов в форматах PDF и PNG.
  2. Взаимосвязь библиотек:
      - **pdftools** (для работы с pdf-файлами), 
      - **magick** (для работы с изображениями),
      - **tesseract** (для распознавания символов).
  3. Обработка файлов с двумя колонками.
  4. Улучшение качества распознавания.
  
---
  
**Оптическое распознавание символов** (или Optical Character Recognition, OCR) -- это процесс преобразования изображения текста в машиночитаемый текстовый формат. Другими словами, процедура отслеживает вариации пикселей на изображении страниц и переводит его в цифровой вид. Необходимость использовать OCR возникает в случае извлечения текстовых данных из изображений. Наиболее часто используемые форматы входных файло для распознавания -- это PDF и PNG.

Наиболее практичные пакеты для работы с pdf-файлами -- `pdftools` (поддерживает высококачественный рендеринг pdf-файлов в форматы PNG, JPEG, TIFF либо растры), с изображениями -- `magick` (самая полная из доступных библиотек обработки изображений). Для распознавания текста с изображений нужен пакет `tesseract`, фактически он и делает всю работу.

Загружаем необходимые библиотеки
```{r libraries}
library(pdftools)
library(magick)
library(tesseract)
library(stringr)
library(magrittr)
```

Для чтения pdf-файлов служит функция `pdf_text()`. Если файл создан по-человечески, то она извлечет текст без запуска OCR. Если же возвращает пустые строки, то тогда нужно распознавание. Можно сделать с помощью функции `pdf_ocr_text()`, она под капотом использует `tesseract::ocr()`. Технически можно перевести изображение из формата .png в формат .pdf. Сначала считав изображение через `magick::image_read()`, затем сохранив его через `magick::image_write()`.

```{r png_to_pdf}
# можем читать и отличный от PNG формат
png_to_pdf <- magick::image_read("Kaz_dict.jpg")
magick::image_write(image = png_to_pdf, format = "pdf", path = "png_to_pdf.pdf")
png_to_pdf
```

Видим, что наша картинка -- это скан первой страницы из толкового словаря казахского языка.

При попытке чтения через `pdf_text()` получаем пустую строку. Причина в том, что pdf-файл сделан из изображения. Распространенный вариант -- это отсканированные документы, сохраненные как PDF.

```{r read_png_to_pdf}
pdftools::pdf_text(pdf = "png_to_pdf.pdf")
```

Если же используем распознавание pdf-файла, то получим результат.

```{r cache=TRUE}
pdftools::pdf_ocr_text(pdf = "png_to_pdf.pdf")
```

Обращаем внимание на сообщение `## Converting page 1 to png_to_pdf_1.png... done!`. Это значит, что функция сконвертировала pdf-файл в png, так как под капотом `pdf_ocr_text()` использует функцию `pdf_convert()`.

Как видно, результат распознавания не совсем такой как ожидалось. Дело в том, что по умолчанию в `pdf_ocr_text()` используется параметр `language = "eng"`. Нам необходим параметр для казахского языка. Страница, где можно поискать доступные для распознавания языки находится [здесь](https://github.com/tesseract-ocr/tessdoc/blob/main/Data-Files-in-different-versions.md). Очевидно, что нам нужен параметр `language = "kaz"`. Однако нам нужно предварительно скачать обучающие данные для выполнения распознавания казахского языка.

```{r tesseract_download, eval=FALSE}
tesseract_download("kaz")
```

Проверяем доступные языки.
```{r tesseract_info}
tesseract_info()$available
```
Далее распознаем текст.

```{r simple_params, cache=TRUE}
text_image <- ocr(image = png_to_pdf, engine = "kaz")
text_image
```
Как видим, казахский язык распознался. Однако в силу того, что изображение содержит два столбца, получается абракадабра. Для того, чтобы разделить столбцы и считать текст правильно, добавим параметр в механизм распознавания `tessedit_pageseg_mode = 1`. Список всех параметров можно получить, вызвав в консоли `tesseract_params()` (на сентябрь 2022 всего 625 параметров). Можно осуществлять поиск параметров, например, `tesseract_params(filter = "tessedit")` и смотреть их описание, например,  `tesseract_params("tessedit_ocr_engine_mode")$desc`.


```{r advanced_params, cache=TRUE}
kaz <- tesseract(language = "kaz", options = list(tessedit_pageseg_mode = 1))
text_image <- ocr(image = png_to_pdf, engine = kaz)
text_image 

```

Сделаем небольшую обработку текста: убирем знаки абзаца и переноса на другую строку.
```{r text_processing}
text_image %>%
  str_replace_all(., "-\\n", "") %>%
  str_squish()
```
Таким образом, мы получаем более-менее приличный результат c параметрами обработки изображений  "из коробки". Возможные сложности -- неточность распознавания, особенно, если есть диакритические знаки, как здесь. Точность процесса OCR зависит от качества входного изображения. Часто можете улучшить результаты, правильно масштабируя изображение, удаляя шум и артефакты или обрезая область, где есть текст. Следует помнить, что `tesseract` лучше всего работает с изображениями с разрешением не менее 300 точек на дюйм. Это можно сделать через параметр `dpi` функции `pdf_convert()`.

Также полезным параметром является параметр `tessedit_char_whitelist`. Ценен тем, что позволяет распознавать текстовые данные в рамках заданных символов. Например, нужно распознать только цифры.

```{r example}
only_numbers <- tesseract(options = list(tessedit_char_whitelist = ".0123456789"))
print(ocr(png_to_pdf, engine = only_numbers))
```

В данном случае алгоритм OCR распознает букву б как 6, букву з как 3 и т.п.

Для более подробного ознакомления с `tesseract` можно воспользоваться соответствующим [руководством](https://tesseract-ocr.github.io/tessdoc/).
